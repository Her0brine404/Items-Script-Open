local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/xHeptc/Kavo-UI-Library/main/source.lua"))()
local Window = Library.CreateLib("Game Joiner", "DarkTheme")
local Tab = Window:NewTab("Teleport")
local Section = Tab:NewSection("Join Game Instance")

-- Переменная для контроля процесса подключения
local cancelTeleport = false

-- Секция с управлением
local Section2 = Tab:NewSection("Control")

-- Кнопка отмены
Section2:NewButton("Cancel Teleport", "Stop current teleport process", function()
    cancelTeleport = true
    print("Teleport cancelled!")
end)

-- Текстовое поле для подключения
Section:NewTextBox("Game Instance", "Format: PlaceID,JobID", function(input)
    -- Сбрасываем флаг отмены
    cancelTeleport = false
    
    -- Парсим ввод
    local args = {}
    
    -- Убираем кавычки и разделяем запятой
    local cleaned = input:gsub("'", ""):gsub('"', '')
    for part in cleaned:gmatch("[^,]+") do
        table.insert(args, part:match("^%s*(.-)%s*$"))
    end
    
    if #args >= 2 then
        local placeId = tonumber(args[1])
        local jobId = args[2]
        
        if placeId and jobId and #jobId > 0 then
            print("Starting teleport to " .. placeId .. ", " .. jobId)
            
            -- Подключаем обработчик ошибок телепортации
            local teleportFailedConnection
            teleportFailedConnection = game:GetService("TeleportService").TeleportInitFailed:Connect(function(player, teleportResult, errorMessage)
                if errorMessage:find("Can't join private instance through specific joins") or 
                   errorMessage:find("Unauthorized") then
                    print("Private instance error detected: " .. errorMessage)
                    cancelTeleport = true
                end
            end)
            
            -- Пытаемся подключиться несколько раз, но проверяем флаг отмены
            for i = 1, 1500 do
                -- Проверяем, не нажата ли кнопка отмены
                if cancelTeleport then
                    print("Teleport process stopped")
                    break
                end
                
                local success, errorMsg = pcall(function()
                    game:GetService('TeleportService'):TeleportToPlaceInstance(placeId, jobId)
                end)
                
                if not success then
                    -- Проверяем, содержит ли ошибка сообщение о приватном инстансе
                    if errorMsg and (errorMsg:find("Can't join private instance through specific joins") or 
                       errorMsg:find("Unauthorized")) then
                        print("Private instance error: " .. errorMsg)
                        cancelTeleport = true
                        break
                    end
                end
                
                wait(0.01)
            end
            
            -- Отключаем обработчик
            if teleportFailedConnection then
                teleportFailedConnection:Disconnect()
            end
            
            if not cancelTeleport then
                print("Teleport process completed")
            else
                print("Teleport process stopped (private instance or user cancelled)")
            end
        else
            print("Invalid input format!")
        end
    else
        print("Please use format: PlaceID,JobID")
    end
end)
